# AWS Elastic Beanstalk Deployment for Crime Arrest Classification Service

AWS Elastic Beanstalk provides a powerful platform-as-a-service solution for deploying web applications and services without the complexity of managing underlying infrastructure. For our crime arrest classification service, Elastic Beanstalk offers an ideal deployment strategy that handles load balancing, auto-scaling, health monitoring, and application versioning automatically. This approach transforms our containerized machine learning model into a production-ready web service that can handle varying traffic loads while maintaining high availability.

## Pre-Deployment Configuration

Before deploying our application, we need to establish proper AWS account security by creating a dedicated IAM user instead of using the root account. This follows AWS security best practices by implementing the principle of least privilege and avoiding root account usage for day-to-day operations.

### Creating a Dedicated IAM User for Deployment

The first step involves creating an IAM user specifically for our Elastic Beanstalk deployment operations. This user will have precisely the permissions needed for deployment without unnecessary access to other AWS services.

#### Step 1: Create IAM User

Navigate to **IAM Console** → **Users** → **Create user**

Configure the user details:

- **User name**: `chicago_crimes_eb_access`
- **Console access**: Enable "Provide user access to the AWS Management Console" (optional but recommended)
- **Console password**: Choose either "Autogenerated password" or "Custom password" following AWS password requirements
- **Password reset**: Optionally require password change at next sign-in for enhanced security

The console access option allows the same credentials to be used for both programmatic access and console login, simplifying credential management during development and troubleshooting.

#### Step 2: Create Custom IAM Policy

Rather than using overly broad managed policies, we create a custom policy that grants only the permissions necessary for Elastic Beanstalk deployment operations.

Under **Set permissions**, select "Attach policies directly" and click **Create policy**.

In the **Policy editor**, select the **JSON** tab and paste the content from `data/iam_user_policy.json`. This policy includes three main permission blocks:

1. **Core Service Permissions**: The first statement grants comprehensive access to Elastic Beanstalk and its dependent services including S3 (for application versions), EC2 (for instances), CloudFormation (for stack management), Elastic Load Balancing, Auto Scaling, and CloudWatch (for monitoring). These permissions are essential because Elastic Beanstalk orchestrates multiple AWS services to create a complete application environment.

2. **Role Management Permissions**: The second statement allows the user to pass specific IAM roles to Elastic Beanstalk services. The `iam:PassRole` permission is restricted to only the roles we'll create for Elastic Beanstalk, preventing privilege escalation. The condition `StringEquals` with `iam:PassedToService` ensures these roles can only be passed to legitimate Elastic Beanstalk and EC2 services.

3. **Service-Linked Role Management**: The third statement permits creation and management of service-linked roles that AWS services create automatically. These roles (like `AWSServiceRoleForAutoScaling` and `AWSServiceRoleForElasticLoadBalancing`) are created by AWS when needed and cannot be created manually.

**Important**: Replace `<account-id>` in the policy with your actual 12-digit AWS account ID found in your console sign-in URL.

Name the policy: `ChicagoCrimesElasticBeanstalkAccess`
Description: "*Access policies for Elastic Beanstalk services used in the Chicago Crimes ML project*"

After creating the policy, return to the user creation tab, refresh the permissions policies list, search for `ChicagoCrimesElasticBeanstalkAccess`, and attach it to the user.

#### Step 3: Create Access Keys for CLI

Programmatic access requires access keys for AWS CLI operations. Navigate to the created user's **Security credentials** tab and create access keys:

1. Click **Create access key**
2. Choose **Command Line Interface (CLI)** and acknowledge the confirmation
3. Add description: "*For Elastic Beanstalk programmatic deployment*"
4. Download or securely store the **Access Key ID** and **Secret Access Key**

These credentials will be used to configure the AWS CLI for deployment operations.

### Creating Required IAM Roles

Elastic Beanstalk requires two specific IAM roles to function properly: an EC2 instance profile role for the application instances and a service role for Elastic Beanstalk itself.

#### Creating the EC2 Instance Profile Role

This role is attached to the EC2 instances that run your application, providing them with the necessary permissions to interact with AWS services.

Navigate to **IAM Console** → **Roles** → **Create role**

Configure the role:

- **Trusted entity**: AWS service
- **Use case**: EC2
- **Permissions**: Attach the following managed policies:
  - `AWSElasticBeanstalkMulticontainerDocker`: Enables Docker container management
  - `AWSElasticBeanstalkWebTier`: Provides web application hosting capabilities
  - `AWSElasticBeanstalkWorkerTier`: Enables background task processing (optional but recommended)

- **Role name**: `aws-eb-ec2-role`
- **Description**: "EC2 role for Elastic Beanstalk applications"

These policies grant the EC2 instances permission to download application versions from S3, write logs to CloudWatch, and communicate with other AWS services as needed by the Elastic Beanstalk platform.

#### Creating the Elastic Beanstalk Service Role

This role allows the Elastic Beanstalk service itself to manage AWS resources on your behalf.

Navigate to **Roles** → **Create role**

Configure the role:

- **Trusted entity**: AWS service
- **Service**: Elastic Beanstalk
- **Use case**: Elastic Beanstalk - Environment
- **Permissions**: The following policies are automatically selected:
  - `AWSElasticBeanstalkEnhancedHealth`: Enables detailed health monitoring
  - `AWSElasticBeanstalkManagedUpdatesCustomerRolePolicy`: Allows managed platform updates

- **Role name**: `aws-eb-service-role`
- **Description**: "Service role for Elastic Beanstalk"

Note: Additional service-linked roles (like `AWSServiceRoleForAutoScaling` and `AWSServiceRoleForElasticLoadBalancing`) will be created automatically by AWS when Elastic Beanstalk provisions the environment.

## AWS CLI Installation and Configuration

The AWS Command Line Interface (CLI) is essential for programmatic interaction with AWS services. If not already installed, follow the [AWS CLI installation guide](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html) for your operating system.

### Environment Variable Configuration

Before proceeding with deployment, configure the following environment variables with your specific AWS account details:

```bash
# Required variables - replace with your actual values
export AWS_ACCOUNT_ID=<your-12-digit-aws-account-id>
export AWS_PROFILE_NAME=<your-aws-profile-name>
export AWS_REGION=<your-preferred-aws-region>
export EB_APP_NAME=<your-elastic-beanstalk-app-name>

# Default values - modify only if you changed role names or container name
export DOCKER_CONTAINER_NAME=chicago-crimes
export EB_SERVICE_ROLE=aws-eb-service-role
export EB_ROLE_NAME=aws-eb-ec2-role
```

Verify your environment variables are set correctly:

```bash
echo "AWS_ACCOUNT_ID: ${AWS_ACCOUNT_ID:-not set}"
echo "AWS_PROFILE_NAME: ${AWS_PROFILE_NAME:-not set}"
echo "AWS_REGION: ${AWS_REGION:-not set}"
echo "EB_APP_NAME: ${EB_APP_NAME:-not set}"
echo "DOCKER_CONTAINER_NAME: ${DOCKER_CONTAINER_NAME:-not set}"
echo "EB_SERVICE_ROLE: ${EB_SERVICE_ROLE:-not set}"
echo "EB_ROLE_NAME: ${EB_ROLE_NAME:-not set}"
```

### AWS CLI Profile Configuration

Create a named AWS CLI profile using the access keys created earlier:

```bash
aws configure --profile ${AWS_PROFILE_NAME}
```

This command prompts for the following information:

- **AWS Access Key ID**: Enter the Access Key ID from the previous step
- **AWS Secret Access Key**: Enter the Secret Access Key from the previous step
- **Default region name**: Enter your preferred AWS region (e.g., `us-east-1`, `eu-west-1`)
- **Default output format**: Leave blank or specify `json`

Example configuration session:

```bash
AWS Access Key ID [None]: AKIAIOSFODNN7EXAMPLE
AWS Secret Access Key [None]: geOrGeJalrXUtnFEMI/eXAMPLeKEy
Default region name [None]: us-east-1
Default output format [None]: json
```

### Verify AWS CLI Configuration

Confirm your AWS CLI configuration is correct:

```bash
# List all configured profiles
aws configure list-profiles

# Display configuration details for your profile
aws configure list --profile ${AWS_PROFILE_NAME}

# Verify the configured region
aws configure get region --profile ${AWS_PROFILE_NAME}

# Test authentication by listing S3 buckets
aws s3 ls --profile ${AWS_PROFILE_NAME}
```

These verification steps ensure proper authentication and regional configuration, which are crucial for successful deployment and cost optimization.

## Elastic Beanstalk CLI Installation

While the AWS CLI can manage Elastic Beanstalk resources, the dedicated EB CLI provides a more streamlined experience for application deployment and management.

Ensure you're in the project's virtual environment:

```bash
uv sync
source .venv/bin/activate  # On Windows: .venv\Scripts\activate
```

The EB CLI is included as a development dependency in the project's `pyproject.toml` file, making it available within the virtual environment. This approach ensures version consistency across different development environments.

Verify the EB CLI installation:

```bash
# Check EB CLI availability and version
eb --version

# Display help documentation
eb --help

# Verify installation location
which eb
```

## Local Testing and Validation

Before deploying to AWS, thoroughly test the application locally to ensure the containerized service functions correctly. This step prevents deployment issues and reduces debugging time in the cloud environment.

### Build and Test Docker Container

Build the Docker image using the same configuration that will be deployed:

```bash
# Build the container image
docker build -t ${DOCKER_CONTAINER_NAME} .

# Run the container locally
docker run -p 8000:8000 ${DOCKER_CONTAINER_NAME}
```

The `docker build` command creates a container image using the Dockerfile in the project root. The `-t` flag tags the image with a name for easy reference. The `docker run` command starts a container from the image, mapping port 8000 from the container to port 8000 on the host system.

### Testing the Local Application

With the container running, test the application endpoints:

```bash
# Test the health endpoint
curl http://localhost:8000/health

# Test the prediction endpoint with sample data
# curl -X POST http://localhost:8000/predict \
#   -H "Content-Type: application/json" \
#   -d '{"primary_type": "THEFT", "location_description": "STREET", "domestic": false}'
```

In development environments like GitHub Codespaces, the `docker run` command may provide a clickable link to access the application through the integrated port forwarding system.

### Container Resource Verification

Monitor the container's resource usage to ensure it will perform well in the Elastic Beanstalk environment:

```bash
# Check container resource usage
docker stats ${DOCKER_CONTAINER_NAME}

# Inspect container configuration
docker inspect ${DOCKER_CONTAINER_NAME}

# View container logs
docker logs ${DOCKER_CONTAINER_NAME}
```

These commands help identify potential performance issues, memory leaks, or configuration problems before deployment.

## Elastic Beanstalk Application Initialization

With local testing complete and AWS credentials configured, initialize the Elastic Beanstalk application. This process creates the application structure and prepares it for deployment.

### Initialize Elastic Beanstalk Application

Navigate to your project directory and initialize the Elastic Beanstalk application:

```bash
eb init
```

The initialization wizard will prompt for several configuration options:

1. **Region Selection**: Choose the AWS region where you want to deploy (should match your configured region)
2. **Application Name**: Enter your application name (use the value from `$EB_APP_NAME`)
3. **Platform**: Select "Docker" as the platform
4. **Platform Version**: Choose the latest Docker platform version
5. **SSH Access**: Optionally configure SSH key pair for instance access

Alternatively, use the non-interactive approach:

```bash
eb init ${EB_APP_NAME} \
  --platform docker \
  --region ${AWS_REGION} \
  --profile ${AWS_PROFILE_NAME}
```

This command creates a `.elasticbeanstalk` directory containing configuration files that define your application's deployment settings.

### Configure Deployment Settings

The initialization process creates a `config.yml` file in the `.elasticbeanstalk` directory. Review and modify this file to ensure proper configuration:

```yaml
branch-defaults:
  main:
    environment: chicago-crimes-env
    group_suffix: null
global:
  application_name: chicago-crimes-classifier
  branch: null
  default_ec2_keyname: null
  default_platform: Docker running on 64bit Amazon Linux 2
  default_region: us-east-1
  include_git_submodules: true
  instance_profile: null
  platform_name: null
  platform_version: null
  profile: chicago-crimes-profile
  repository: null
  sc: git
  workspace_type: Application
```

This configuration ensures consistent deployment behavior and proper integration with your AWS profile and regional settings.h, just close that Codespace and go the `PORTS` tab in VSCode and click the link under **Forwarded Address**.

You can then check the workings of the application by uploading one of the `test_2025.csv` data located in the `data/` folder. If everything works out correctly, we can now move to deploying the application to AWS Elastic Beanstalk. Remember to go terminate running application from your terminal using `Ctrl + C` (Windows OS) or `Cmd + C` (MacOS)

## Application Initialization

The initialization of an Elastic Beanstalk application establishes the foundational configuration for your deployment environment. The `eb init` command creates the necessary project structure and configuration files. For our crime arrest classification service, the initialization command specifies Docker as the platform, sets the application name, defines the target region, and uses a specific AWS profile.

Run the command below to ...

```sh
eb init ${EB_APP_NAME} \
  -p docker \
  -r ${AWS_REGION} \
  --profile ${AWS_PROFILE_NAME}
```

This command produces output confirming the application creation when run for the first time as:

```sh
"Application crime-arrest-classifier has been created."
```

The initialization process creates a `.elasticbeanstalk/` directory containing a `config.yml` file that stores essential configuration parameters including the application name, default environment settings, platform specification, and regional deployment preferences. This configuration file serves as the blueprint for all subsequent deployment operations and can be version-controlled alongside your application code.

Elastic Beanstalk provides local testing capabilities that simulate the production environment:

```sh
eb local run --port 8000
```

*this runs into an error:

```sh
ERROR: NotSupportedError - You can use "eb local" only with preconfigured, generic and multicontainer Docker platforms.
```

this error requires that you know put in the set the `default_platform` parameter under `global` in the `config.yml` file found in `.elasticbeanstalk/` folder to something that resembles this (replace `<region>` with your aws region):

```sh
arn:aws:elasticbeanstalk:af-south-1::platform/Docker running on 64bit Amazon Linux 2/4.3.3
```

Usually this is found after running the `eb create` command which we'll look at next.

*but if it doesn't, the `docker run` test carried in the previous step just does the trick to show that your application is working.

The local testing feature rebuilds the Docker image to incorporate any recent changes, including newly added dependencies like the Elastic Beanstalk CLI. The command below initiates local testing on port 8000:

During local testing, Elastic Beanstalk recreates the Docker image since modifications were made to the project dependencies. This process ensures that the local test environment accurately reflects the production deployment, including all recent code changes and dependency updates. Local testing provides confidence that the application will function correctly in the cloud environment before incurring deployment costs.

## Cloud Deployment

The cloud deployment process transforms your local application into a fully managed, scalable web service. The `eb create` command provisions all necessary AWS resources and deploys your application.

before jumping into the creation of elasticbeanstalk, we have to note the following:
This step is required even if the instance profile was created via the AWS Console.
Creating an instance profile does not automatically attach the role.

Step 1: Check if an instance profile already exists

```sh
aws iam create-instance-profile \
  --instance-profile-name ${EB_ROLE_NAME} \
  --profile ${AWS_PROFILE_NAME}
```

If this succeeds it means that the profile didn't exist and has been created. However, in our case, it will returns: `EntityAlreadyExists` → profile already exists (this is OK).

Now check if the `aws-eb-ec2-role` is attached to it using the command below:

```sh
aws iam list-instance-profiles-for-role \
  --role-name ${EB_ROLE_NAME} \
  --profile ${AWS_PROFILE_NAME}
```

If it returns:

```json
{
    "InstanceProfiles": []
}
```

Step 2: Attach the role to the instance profile (MANDATORY) the instance profile name should be the same with the role name

If the `InstanceProfiles` from the previous command is an empty list, this step is not optional because Elastic Beanstalk will fail without it. However, if the list was not empty, then you might skip or run it. In the later case you'll get `(LimitExceeded)` error which is okay.

```sh
aws iam add-role-to-instance-profile \
  --instance-profile-name ${EB_ROLE_NAME} \
  --role-name ${EB_ROLE_NAME} \
  --profile ${AWS_PROFILE_NAME}
```

Step 3: Verify attachment (Authoritative Check)

```sh
aws iam list-instance-profiles-for-role \
  --role-name ${EB_ROLE_NAME} \
  --profile ${AWS_PROFILE_NAME}
```

Expected output:

```json
{
  "InstanceProfiles": [
    {
      "InstanceProfileName": "aws-eb-ec2-role",
      "Roles": [
        {
          "RoleName": "aws-eb-ec2-role"
        }
      ]
    }
  ]
}
```

Now run the `eb create` command as follows:

```sh
eb create ${EB_APP_NAME}-env \
  --service-role ${EB_SERVICE_ROLE} \
  --instance_profile ${EB_ROLE_NAME} \
  --profile ${AWS_PROFILE_NAME}
```

eb create ${EB_APP_NAME}-env

This deployment command initiates a comprehensive provisioning process that creates multiple AWS resources automatically. The output below demonstrates the extensive infrastructure setup that occurs during deployment:

```txt
Creating application version archive "app-1fb9-251022_200949986533".
Uploading: [##################################################] 100% Done...
Environment details for: <application-name>-env
  Application name: <application-name>
  Region: <region>
  Deployed Version: app-1fb9-251022_200949986533
  Environment ID: e-pkdgapqcmu
  Platform: arn:aws:elasticbeanstalk:<region>::platform/Docker running on 64bit Amazon Linux 2023/4.7.2
  Tier: WebServer-Standard-1.0
  CNAME: UNKNOWN
  Updated: 2025-08-29 17:11:16.230000+00:00
```

*you might also notice the alert from the terminal output:

```sh
Alert: The platform version that your environment is using isn't recommended. There's a recommended version in the same platform branch.
```

this can fixed by either upgrading it through the Elastic Beanstalk Console then navigate to **Environment** where you'll see **Platform**. Click the **Change version** button. Or you can use the CLI command:

```sh
eb upgrade --profile ${AWS_PROFILE_NAME}
```

### Infrastructure Provisioning and Components

The deployment process creates several critical infrastructure components automatically.

- First, Elastic Beanstalk establishes an S3 storage bucket for environment data and application versions, as indicated by the message "Using `elasticbeanstalk-<region>-<aws-account-id>` as Amazon S3 storage bucket for environment data."

- Security groups are created to control network access, with both application-specific and load balancer security groups being provisioned.

- The auto-scaling infrastructure includes the creation of an Auto Scaling group that can automatically adjust the number of running instances based on demand. The system also establishes scaling policies for both scale-up and scale-down operations, ensuring that your application can handle traffic spikes while minimizing costs during low-demand periods.

CloudWatch alarms are configured to monitor application performance and trigger scaling actions when predefined thresholds are exceeded.

Load balancing capabilities are implemented through an Application Load Balancer that distributes incoming requests across multiple instances. The load balancer includes health checks to ensure that traffic is only routed to healthy instances, and it provides a stable endpoint for accessing your application.

The final deployment message confirms successful completion:

```sh
"Application available at `<environment>.eba-jtwzks97.<region>.elasticbeanstalk.com`"
```

You can either highlight the link and open in a new tab or navigate to the AWS Elastic Beanstalk console -> **Environments** and click the link provided under **Domain** column. In case you don't see your application or environment, ensure you check if the region your are logged in is the right one.

### Monitoring and Management

To monitor and manage your deployed application, navigate to the AWS Console and ensure that your selected region matches the deployment region specified in your configuration. If you cannot locate your application in the console, use the hamburger menu to navigate to the Elastic Beanstalk service section. The console provides comprehensive monitoring capabilities, including application health status, request metrics, log access, and configuration management options.

Understanding the cost implications of Elastic Beanstalk deployment is crucial for budget management. While Elastic Beanstalk itself does not incur additional charges beyond the underlying AWS resources, the deployed infrastructure includes EC2 instances, load balancers, and other services that generate costs. The AWS Free Tier provides limited usage of these resources for new accounts, making it possible to experiment with deployments at minimal cost. For production deployments, consider implementing cost optimization strategies such as scheduled scaling, instance right-sizing, and environment termination during non-business hours.

### Security Consideration

Security considerations are paramount when deploying machine learning services to the cloud. By default, Elastic Beanstalk creates publicly accessible endpoints, which means your application is available to anyone with the URL. For production deployments, implement proper access controls through security groups, VPC configurations, and authentication mechanisms. Consider restricting access to specific IP ranges, implementing API authentication, or deploying within a private subnet with controlled access points.
